<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fitting the model &mdash; The Ten Equations  documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sg_gallery.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sg_gallery-binder.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sg_gallery-dataframe.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sg_gallery-rendered-html.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Predictions World Cup 2022" href="plot_predictions.html" />
    <link rel="prev" title="Odds and probabilities" href="../../lesson1/ProbabilitiesOdds.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html">
            <img src="../../_static/TENLogo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">The Betting Equation:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../lesson1/Introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lesson1/ProbabilitiesOdds.html">Odds and probabilities</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Fitting the model</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#making-the-bookmakers-odds-fair">Making the bookmakers odds fair</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id1">Logistic regression</a></li>
<li class="toctree-l2"><a class="reference internal" href="#plotting-the-predictions">Plotting the predictions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#opening-odds">Opening odds</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="plot_predictions.html">Predictions World Cup 2022</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">The Judgement Equation:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../lesson2/plot_bayes.html">Bayes Rule</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">The Ten Equations</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Fitting the model</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p>Click <a class="reference internal" href="#sphx-glr-download-gallery-lesson1-plot-betting-py"><span class="std std-ref">here</span></a>
to download the full example code</p>
</div>
<div class="sphx-glr-example-title section" id="fitting-the-model">
<span id="fitmodel"></span><span id="sphx-glr-gallery-lesson1-plot-betting-py"></span><h1>Fitting the model<a class="headerlink" href="#fitting-the-model" title="Permalink to this heading"></a></h1>
<p>In this section we use odds from previous tournaments to
fit the model to data. We do this using a method known
as <a class="reference external" href="https://youtu.be/yIYKR4sgzI8">logistic regression</a>.
Let’s start by loading in the data.</p>
<p>The odds here are for two World Cups and two Euros. They are given
in European form. Remember, the UK odds are found by taking away one
from the European odds.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import the libraries we will use.</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">import</span> <span class="nn">statsmodels.formula.api</span> <span class="k">as</span> <span class="nn">smf</span>

<span class="c1"># Load in the data</span>
<span class="n">wc_load</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;../data/WorldCupEuroCupOdds.csv&quot;</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
<span class="n">wc_load</span> <span class="o">=</span> <span class="n">wc_load</span><span class="p">[(</span><span class="n">wc_load</span><span class="p">[</span><span class="s1">&#39;Stage&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">wc_load</span><span class="p">[</span><span class="s1">&#39;Stage&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">2</span><span class="p">)]</span>
<span class="n">wc</span> <span class="o">=</span> <span class="n">wc_load</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;FTHG&#39;</span><span class="p">:</span> <span class="s1">&#39;HomeGoals&#39;</span><span class="p">,</span> <span class="s1">&#39;FTAG&#39;</span><span class="p">:</span> <span class="s1">&#39;AwayGoals&#39;</span><span class="p">})</span>

<span class="c1"># We start by looking at the closing odds</span>
<span class="n">wc_df</span> <span class="o">=</span> <span class="n">wc</span><span class="p">[[</span><span class="s1">&#39;AwayTeam&#39;</span><span class="p">,</span><span class="s1">&#39;HomeTeam&#39;</span><span class="p">,</span><span class="s1">&#39;HomeGoals&#39;</span><span class="p">,</span><span class="s1">&#39;AwayGoals&#39;</span><span class="p">,</span><span class="s1">&#39;PSH&#39;</span><span class="p">,</span><span class="s1">&#39;PSD&#39;</span><span class="p">,</span><span class="s1">&#39;PSA&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">goaldiff</span><span class="o">=</span><span class="n">wc</span><span class="p">[</span><span class="s1">&#39;HomeGoals&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">wc</span><span class="p">[</span><span class="s1">&#39;AwayGoals&#39;</span><span class="p">])</span>
<span class="n">oddslabel</span><span class="o">=</span><span class="s1">&#39;Closing odds&#39;</span>
</pre></div>
</div>
<div class="section" id="making-the-bookmakers-odds-fair">
<h2>Making the bookmakers odds fair<a class="headerlink" href="#making-the-bookmakers-odds-fair" title="Permalink to this heading"></a></h2>
<p>Bookmakers odds are set up so that they have a margin (an edge). If we calculate</p>
<div class="math notranslate nohighlight">
\[t = \frac{1}{o_\mbox{home}} + \frac{1}{o_\mbox{draw}} + \frac{1}{o_\mbox{away}}\]</div>
<p>where</p>
<div class="math notranslate nohighlight">
\[o_\mbox{home}, o_\mbox{draw} \mbox{ and  } o_\mbox{away}\]</div>
<p>are the (European) odds of each outcome – then we typically find a value
greater than one (if it is one then the odds are fair). For more about making odds
fair (and another method for correcting the odds for the margin) see
<a class="reference external" href="https://www.football-data.co.uk/The_Wisdom_of_the_Crowd_updated.pdf">here</a></p>
<p>To make the probabilities implied by the odds fair we thus divide each
of the probabilites by <span class="math notranslate nohighlight">\(t\)</span>. Now the probabilities of the three outcomes add up
to one. This is done below, along with a change that allows us to work out
values for the favourite.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">MakeOddsCalculations</span><span class="p">(</span><span class="n">wc_df</span><span class="p">):</span>
    <span class="c1"># Calculate win, draw and lose for the outcomes.</span>
    <span class="n">wc_df</span> <span class="o">=</span> <span class="n">wc_df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">draw</span><span class="o">=</span><span class="p">(</span><span class="n">wc</span><span class="p">[</span><span class="s1">&#39;HomeGoals&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">wc</span><span class="p">[</span><span class="s1">&#39;AwayGoals&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">homewin</span><span class="o">=</span><span class="p">(</span><span class="n">wc</span><span class="p">[</span><span class="s1">&#39;HomeGoals&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="n">wc</span><span class="p">[</span><span class="s1">&#39;AwayGoals&#39;</span><span class="p">]))</span>
    <span class="n">wc_df</span> <span class="o">=</span> <span class="n">wc_df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">awaywin</span><span class="o">=</span><span class="p">(</span><span class="n">wc</span><span class="p">[</span><span class="s1">&#39;HomeGoals&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="n">wc</span><span class="p">[</span><span class="s1">&#39;AwayGoals&#39;</span><span class="p">]))</span>

    <span class="c1"># Calculate fair odds.</span>
    <span class="n">totprob</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="n">wc_df</span><span class="p">[</span><span class="s1">&#39;PSH&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="o">/</span><span class="n">wc_df</span><span class="p">[</span><span class="s1">&#39;PSA&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="o">/</span><span class="n">wc_df</span><span class="p">[</span><span class="s1">&#39;PSD&#39;</span><span class="p">]</span>
    <span class="n">wc_df</span> <span class="o">=</span> <span class="n">wc_df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">homeprob</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="n">wc_df</span><span class="p">[</span><span class="s1">&#39;PSH&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">totprob</span><span class="p">)</span>
    <span class="n">wc_df</span> <span class="o">=</span> <span class="n">wc_df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">awayprob</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="n">wc_df</span><span class="p">[</span><span class="s1">&#39;PSA&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">totprob</span><span class="p">)</span>
    <span class="n">wc_df</span> <span class="o">=</span> <span class="n">wc_df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">drawprob</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="n">wc_df</span><span class="p">[</span><span class="s1">&#39;PSD&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">totprob</span><span class="p">)</span>

    <span class="c1"># Calculate in terms of favourite.</span>
    <span class="n">wc_df</span> <span class="o">=</span> <span class="n">wc_df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">favwin</span><span class="o">=</span><span class="p">((</span><span class="n">wc_df</span><span class="p">[</span><span class="s1">&#39;homewin&#39;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">wc_df</span><span class="p">[</span><span class="s1">&#39;homeprob&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="n">wc_df</span><span class="p">[</span><span class="s1">&#39;awayprob&#39;</span><span class="p">]))</span> <span class="o">|</span> <span class="n">wc_df</span><span class="p">[</span><span class="s1">&#39;awaywin&#39;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">wc_df</span><span class="p">[</span><span class="s1">&#39;awayprob&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="n">wc_df</span><span class="p">[</span><span class="s1">&#39;homeprob&#39;</span><span class="p">])))</span>
    <span class="n">wc_df</span> <span class="o">=</span> <span class="n">wc_df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">favprob</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">wc_df</span><span class="p">[</span><span class="s1">&#39;homeprob&#39;</span><span class="p">],</span><span class="n">wc_df</span><span class="p">[</span><span class="s1">&#39;awayprob&#39;</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">wc_df</span>


<span class="n">wc_df</span> <span class="o">=</span> <span class="n">MakeOddsCalculations</span><span class="p">(</span><span class="n">wc_df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id1">
<h2>Logistic regression<a class="headerlink" href="#id1" title="Permalink to this heading"></a></h2>
<p>A logistic regression model has the following form</p>
<div class="math notranslate nohighlight">
\[P( Y = 1 | z ) = \frac{1}{1 + \exp(b_0+b_1 z)}\]</div>
<p>where <span class="math notranslate nohighlight">\(z\)</span> is a feature of the data and <span class="math notranslate nohighlight">\(Y\)</span> is the event to be predicted. In our case, <span class="math notranslate nohighlight">\(Y\)</span>
is the event that the favourite wins. So, <span class="math notranslate nohighlight">\(Y=1\)</span> means the favourit wins, <span class="math notranslate nohighlight">\(Y=0\)</span>
means they don’t (draw or underdog wins).</p>
<p>In the last:ref:<cite>section&lt;oddsandprobs&gt;</cite> section, we presented
The Betting Equation as</p>
<div class="math notranslate nohighlight" id="equation-eq-betting">
<span class="eqno">(1)<a class="headerlink" href="#equation-eq-betting" title="Permalink to this equation"></a></span>\[P( Y = 1 | x ) = \frac{1}{1 + \alpha x^\beta}\]</div>
<p>where <span class="math notranslate nohighlight">\(x\)</span> are the fair odds for the favourite in UK form. These two equations
are slightly different but related. What we need to do now is find a
a way of calculating <span class="math notranslate nohighlight">\(z\)</span> from the data we have just loaded in and use it to
estimate <span class="math notranslate nohighlight">\(\alpha\)</span> and <span class="math notranslate nohighlight">\(\beta\)</span>.</p>
<p>The (fair) UK odds for the favourite is the ratio of the probability that the favourite doesn’t win and
the probability that the favourite does win. That is</p>
<div class="math notranslate nohighlight">
\[x = 1/p - 1 = \frac{1-p}{p}\]</div>
<p>where <span class="math notranslate nohighlight">\(p\)</span> is the probability that the favourite wins. We now set</p>
<div class="math notranslate nohighlight">
\[z = \ln \left( \frac{p}{1-p} \right) = - \ln \left( x \right)\]</div>
<p>From this, we get</p>
<div class="math notranslate nohighlight">
\[\begin{split}P( Y = 1 | z ) &amp;= \frac{1}{1 + \exp(b_0+b_1 z)} \\
               &amp;= \frac{1}{1 + \exp(b_0 - b_1 \ln ( x ) )} \\
               &amp;= \frac{1}{1 + \exp(b_0) \exp \left( \ln(x)^{-b_1} \right)} \\
               &amp;= \frac{1}{1 + \exp(b_0) x^{-b_1}} \\\end{split}\]</div>
<p>This is the same as the <a class="reference internal" href="#equation-eq-betting">(1)</a>, with <span class="math notranslate nohighlight">\(\alpha = \exp(b_0)\)</span> and <span class="math notranslate nohighlight">\(\beta = - b_1\)</span>.</p>
<p>Let’s calculate the log odds for our data.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a variable which is log odds.</span>

<span class="n">wc_df</span> <span class="o">=</span> <span class="n">wc_df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">favlog</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">wc_df</span><span class="p">[</span><span class="s1">&#39;favprob&#39;</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">wc_df</span><span class="p">[</span><span class="s1">&#39;favprob&#39;</span><span class="p">])))</span>
</pre></div>
</div>
<p>Now lets import tools required for a logistic regression model
and use them to fit the parameters.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">test_model</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">glm</span><span class="p">(</span><span class="n">formula</span><span class="o">=</span><span class="s2">&quot;favwin ~ favlog&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">wc_df</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="n">sm</span><span class="o">.</span><span class="n">families</span><span class="o">.</span><span class="n">Binomial</span><span class="p">())</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">test_model</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
<span class="n">b</span><span class="o">=</span><span class="n">test_model</span><span class="o">.</span><span class="n">params</span>
<span class="n">alpha</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">beta</span><span class="o">=-</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Estimate of alpha: &#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Estimate of beta: &#39;</span><span class="p">,</span><span class="n">beta</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>                         Generalized Linear Model Regression Results
=============================================================================================
Dep. Variable:     [&#39;favwin[False]&#39;, &#39;favwin[True]&#39;]   No. Observations:                  283
Model:                                           GLM   Df Residuals:                      281
Model Family:                               Binomial   Df Model:                            1
Link Function:                                 Logit   Scale:                          1.0000
Method:                                         IRLS   Log-Likelihood:                -180.75
Date:                               Sun, 13 Nov 2022   Deviance:                       361.49
Time:                                       16:52:12   Pearson chi2:                     283.
No. Iterations:                                    4   Pseudo R-squ. (CS):             0.1031
Covariance Type:                           nonrobust
==============================================================================
                 coef    std err          z      P&gt;|z|      [0.025      0.975]
------------------------------------------------------------------------------
Intercept      0.1293      0.128      1.012      0.311      -0.121       0.380
favlog        -1.2954      0.252     -5.131      0.000      -1.790      -0.801
==============================================================================
Estimate of alpha:  1.1380456338486287
Estimate of beta:  1.2954245420192907
</pre></div>
</div>
<p>We now have an estimate of our paramters <span class="math notranslate nohighlight">\(\alpha\)</span> and <span class="math notranslate nohighlight">\(\beta\)</span>.</p>
</div>
<div class="section" id="plotting-the-predictions">
<h2>Plotting the predictions<a class="headerlink" href="#plotting-the-predictions" title="Permalink to this heading"></a></h2>
<p>Let’s plot the model and compare it to the data.
Notice that we make the comparison as a difference between reality
and outcome.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">FormatFigure</span><span class="p">(</span><span class="n">ax</span><span class="p">):</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.16</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">),</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;%&quot;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">5</span><span class="p">)])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.01</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;%&quot;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="mi">20</span><span class="p">)])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Win probability implied by odds&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Actual win prob - dds win prob&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Probability favourite wins&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ax</span>


    <span class="c1">#Favourite model</span>

<span class="k">def</span> <span class="nf">PlotOddsData</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span><span class="n">wc_df</span><span class="p">):</span>
    <span class="n">wins</span> <span class="o">=</span> <span class="n">wc_df</span><span class="p">[</span><span class="s1">&#39;favwin&#39;</span><span class="p">]</span>
    <span class="n">winpreds</span> <span class="o">=</span> <span class="n">wc_df</span><span class="p">[</span><span class="s1">&#39;favprob&#39;</span><span class="p">]</span>
    <span class="n">numbins</span><span class="o">=</span><span class="mi">15</span>
    <span class="n">bin_means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">numbins</span><span class="p">)</span>
    <span class="n">bin_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">numbins</span><span class="p">)</span>
    <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="o">/</span><span class="n">numbins</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="n">numbins</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">lb</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">lbp1</span><span class="o">=</span><span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dfs</span><span class="o">=</span><span class="n">wins</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">winpreds</span><span class="o">&gt;=</span><span class="n">lb</span><span class="p">,</span><span class="n">winpreds</span><span class="o">&lt;</span><span class="n">lbp1</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">bin_means</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span>
            <span class="n">bin_counts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">numbins</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bin_means</span><span class="p">)</span><span class="o">-</span><span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">numbins</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">bin_counts</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> (data)&#39;</span> <span class="o">%</span> <span class="n">oddslabel</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ax</span>

<span class="n">p</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span><span class="mf">0.99</span><span class="p">,</span><span class="mf">0.00001</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">alpha</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">)</span><span class="o">/</span><span class="n">p</span><span class="p">,</span><span class="n">beta</span><span class="p">))</span><span class="o">-</span><span class="n">p</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">oddslabel</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">PlotOddsData</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span><span class="n">wc_df</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">FormatFigure</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_plot_betting_001.png" srcset="../../_images/sphx_glr_plot_betting_001.png" alt="Probability favourite wins" class = "sphx-glr-single-img"/><p>These values caught my attention immediately when I first fit this model.
The fact that both parameters, α and β, were
bigger than 1 indicated that there was a (small) bias in the way the odds
were set.</p>
<p>The plot above shows two ways in which we might have an edge
Firstly, the right hand side of the plot shows that a
long-shot bias exists against strong favourites.
These teams are typically under-estimated by the bookmakers’ odds
and therefore worth backing. The middle and left hand side of the plot
shows that weaker favourites are over-estimated. This difference between
odds and outcome is even more pronounced and seems to be where
most of the value in the model is to be found.</p>
<p>Although these differences between predictions and model were small,
Jan, Marius and I knew that they were big enough for us to make a profit…</p>
</div>
<div class="section" id="opening-odds">
<h2>Opening odds<a class="headerlink" href="#opening-odds" title="Permalink to this heading"></a></h2>
<p>We found a similar pattern in the opening odds as the closing odds, but
the bias was smaller. We do this fitting below.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wc_df</span> <span class="o">=</span> <span class="n">wc</span><span class="p">[[</span><span class="s1">&#39;AwayTeam&#39;</span><span class="p">,</span><span class="s1">&#39;HomeTeam&#39;</span><span class="p">,</span><span class="s1">&#39;HomeGoals&#39;</span><span class="p">,</span><span class="s1">&#39;AwayGoals&#39;</span><span class="p">,</span><span class="s1">&#39;Home Open&#39;</span><span class="p">,</span><span class="s1">&#39;Draw Open&#39;</span><span class="p">,</span><span class="s1">&#39;Away Open&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">goaldiff</span><span class="o">=</span><span class="n">wc</span><span class="p">[</span><span class="s1">&#39;HomeGoals&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">wc</span><span class="p">[</span><span class="s1">&#39;AwayGoals&#39;</span><span class="p">])</span>
<span class="n">wc_df</span> <span class="o">=</span> <span class="n">wc_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Home Open&#39;</span><span class="p">:</span> <span class="s1">&#39;PSH&#39;</span><span class="p">,</span> <span class="s1">&#39;Away Open&#39;</span><span class="p">:</span> <span class="s1">&#39;PSA&#39;</span><span class="p">,</span> <span class="s1">&#39;Draw Open&#39;</span><span class="p">:</span> <span class="s1">&#39;PSD&#39;</span><span class="p">})</span>
<span class="n">oddslabel</span><span class="o">=</span><span class="s1">&#39;Opening odds&#39;</span>
<span class="n">wc_df</span> <span class="o">=</span> <span class="n">MakeOddsCalculations</span><span class="p">(</span><span class="n">wc_df</span><span class="p">)</span>

<span class="n">wc_df</span> <span class="o">=</span> <span class="n">wc_df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">favlog</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">wc_df</span><span class="p">[</span><span class="s1">&#39;favprob&#39;</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">wc_df</span><span class="p">[</span><span class="s1">&#39;favprob&#39;</span><span class="p">])))</span>

<span class="n">test_model</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">glm</span><span class="p">(</span><span class="n">formula</span><span class="o">=</span><span class="s2">&quot;favwin ~ favlog&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">wc_df</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="n">sm</span><span class="o">.</span><span class="n">families</span><span class="o">.</span><span class="n">Binomial</span><span class="p">())</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">test_model</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
<span class="n">b</span><span class="o">=</span><span class="n">test_model</span><span class="o">.</span><span class="n">params</span>
<span class="n">alpha</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">beta</span><span class="o">=-</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Estimate of alpha: &#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Estimate of beta: &#39;</span><span class="p">,</span><span class="n">beta</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">alpha</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">)</span><span class="o">/</span><span class="n">p</span><span class="p">,</span><span class="n">beta</span><span class="p">))</span><span class="o">-</span><span class="n">p</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">oddslabel</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">PlotOddsData</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span><span class="n">wc_df</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">FormatFigure</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_plot_betting_002.png" srcset="../../_images/sphx_glr_plot_betting_002.png" alt="Probability favourite wins" class = "sphx-glr-single-img"/><div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>                         Generalized Linear Model Regression Results
=============================================================================================
Dep. Variable:     [&#39;favwin[False]&#39;, &#39;favwin[True]&#39;]   No. Observations:                  259
Model:                                           GLM   Df Residuals:                      257
Model Family:                               Binomial   Df Model:                            1
Link Function:                                 Logit   Scale:                          1.0000
Method:                                         IRLS   Log-Likelihood:                -169.67
Date:                               Sun, 13 Nov 2022   Deviance:                       339.33
Time:                                       16:52:12   Pearson chi2:                     259.
No. Iterations:                                    4   Pseudo R-squ. (CS):            0.07218
Covariance Type:                           nonrobust
==============================================================================
                 coef    std err          z      P&gt;|z|      [0.025      0.975]
------------------------------------------------------------------------------
Intercept      0.0365      0.131      0.280      0.780      -0.219       0.293
favlog        -1.1051      0.267     -4.146      0.000      -1.627      -0.583
==============================================================================
Estimate of alpha:  1.0372197647675445
Estimate of beta:  1.105112298236666
</pre></div>
</div>
<p>As the big tournaments approach the odds reflect reality less!
This is seen in values of  α and β being closer to one
for the opening odds than for the closing odds (above).</p>
<a class="reference internal image-reference" href="../../_images/ClosingOddsWorse.png"><img alt="../../_images/ClosingOddsWorse.png" class="align-center" src="../../_images/ClosingOddsWorse.png" style="width: 640px;" /></a>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> ( 0 minutes  1.516 seconds)</p>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-gallery-lesson1-plot-betting-py">
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/edffe992414be1288b50fd874a23b961/plot_betting.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">plot_betting.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/d1b34d104a3aa11e3d83d44ff4143146/plot_betting.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">plot_betting.ipynb</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../../lesson1/ProbabilitiesOdds.html" class="btn btn-neutral float-left" title="Odds and probabilities" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="plot_predictions.html" class="btn btn-neutral float-right" title="Predictions World Cup 2022" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, David Sumpter.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>